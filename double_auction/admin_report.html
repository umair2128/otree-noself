<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"/>

<!-- Linking Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/modules/boost.js"></script>

<div class="container">
    <br>

    <ul class="nav nav-tabs"> <!-- Tabs Panel -->
        <li class="active"><a data-toggle="tab" href="#sub_info">Subject Info</a></li>
        <li><a data-toggle="tab" href="#mkt_act">Market Activity</a></li>
        <li><a data-toggle="tab" href="#mkt_hist">Market History</a></li>
    </ul>

    <br>

    <div class="row" style="vertical-align:middle;align-items:center;justify-content: center;"> <!-- Navigation Buttons Panel -->
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-first"><i class="bi-chevron-double-left"></i></button>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-prev"><i class="bi-chevron-left"></i></button>
        </div>
        <div class="col-5" style="border: none;text-align:center;">
            <span id="hist_text"></span>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-next"><i class="bi-chevron-right"></i></button>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-last"><i class="bi-chevron-double-right"></i></button>
        </div>
    </div>

    <div class="tab-content">
        <div id="sub_info" class="tab-pane fade in active"> <!-- Content under the Subjects Info Tab  -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Subjects Table</h4>
            </div>
            <div class="row" style="height:500px;overflow-y:scroll;">
                <table id="sub_info_table" class="table table-sm" style="table-layout:fixed;height:6px;width:100%;border-collapse:collapse;"><thead></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="mkt_act" class="tab-pane fade"> <!-- Content under the Market Activity Tab  -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Summary Table</h4>
            </div>
            <div class="row" style="height:500px;overflow-y:scroll;">
                <table id="period_sum_table" class="table table-sm" style="table-layout:fixed;height:6px;width:100%;border-collapse:collapse;"><thead></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="mkt_hist" class="tab-pane fade"> <!-- Content under the Market History Tab  -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Summary Graph</h4>
            </div>
            <div class="row">
                <div id="pred_eq_box" style="margin-left:15%;font-size:12px;width:15%;border:1px solid #A7A7A7;background-color:#F1F1F1;vertical-align:bottom;text-align:left;justify-content:right;align-items:right;"></div>
            </div>
            <div class="row">
                <div class="col-12">
                    <table id="Container" width="100%">
                        <tr>
                            <td width="5%" valign="top" align="center">
                                <div class="mb-2"><input type="text" id="amount_h" readonly style="font-size:14px; width:100px; border:0; text-align:center; vertical-align:top; font-weight:bold;"></div>
                                <div id="slider-range" style="width:12px; height:280px;"></div>
                                <div class="mt-2"><input type="text" id="amount_l" readonly style="font-size:14px; width:100px; border:0; text-align:center; vertical-align:bottom; font-weight:bold;"></div>
                            </td>
                            <td width="95%">
                                <div id="Graph" style="height: 400px; min-width: 300px"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="row">
                <span id="description" style="visibility:hidden;"></span>
            </div>
        </div>
    </div>
</div>


<style>
    form {
        display: none;
    }

    .btn-sm.btn-primary[disabled] {
        background-color: #abc7db;
        border-color: #9bb6c9;
    }

    exp {
      display: inline-block;
      position: relative;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
      text-align: center;
    }

    exp:hover {
        z-index: 1;
        width: auto;
        font-family: monospace;
        background-color: #FFFFCC;
    }
</style>


<script>
    let offers = {{offers | safe}}; // A detailed list of all the offers in the experiment
    let transactions = {{transactions | safe}}; // A detailed list of all the successful transactions in the experiment
    let buyers_data = {{buyers_data | safe}}; // The data used to draw the demand curve based on induced values
    let sellers_data = {{sellers_data | safe}}; // The data used to draw the supply curve based on induced values
    let total_rounds = {{total_rounds | safe}}; // Total number of rounds in the experiment
    let players_data = {{players_data}}; // Detailed data on players' role, inducements, trades, and payoff in the experiment

    let hist_text = document.getElementById('hist_text'); // Caption for the Navigation Tab indicating the period for which the information is displayed
    let description = document.getElementById('description'); // Description of the graph

    let hist_round = 1; // Keeps track of the round for which the information is displayed

    let max_y = 100; // The maximum value for the vertical axis (initially 100)
    let min_y = 0; // The minimum value for the vertical axis (initially 0)

    let eq_q = 0; // Captures the predicted equilibrium quantity in a given period based on induced values
    let eq_p_l = 0; // Captures the lower bound for the predicted equilibrium price in a given period based on induced values
    let eq_p_h = 0; // Captures the upper bound for the predicted equilibrium price in a given period based on induced values

    let bids = []; // Uses 'offers' to populate the data on bids for the summary graph for a given period
    let asks = []; // Uses 'offers' to populate the data on asks for the summary graph for a given period
    let buys = []; // Uses 'transactions' to populate the data on purchases for the summary graph for a given period
    let sells = []; // Uses 'transactions' to populate the data on sales for the summary graph for a given period


    window.onload = function () {
        reset_hist_nav_buttons(); // On page load, this resets the navigation buttons panel to their period 1 state
        set_yaxis_limits(hist_round); // Sets the vertical axis lower and upper limits for the summary graph for the given period
        set_eq(hist_round); // This determines the equilibrium price range and the equilibrium quantity given the induced values in the period in question
        prepare_offers_data(hist_round); // Prepares the data to display 'bids' and 'asks' as scatter points on the summary graph for a given period
        prepare_transaction_data(hist_round); // Prepares the data to display 'buys' and 'sells' as scatter points on the summary graph for the given period
        populate_sub_info_table(hist_round); // Populates the subjects information table which displays, for each subject, their id, role, units endowed, units traded, period and cumulative payoffs in the given round
        populate_period_sum_table(hist_round); // Populates the period summary table which displays an ordered (by time left) list of offers (bids/asks) and transactions (purchases/sales) which have taken place in the given period
        upd_pred_eq_box(); // Shows the predicted equilibrium price range and quantity in a box on the top-left of the summary graph
        draw_graph(hist_round); // Draws the summary graph for the given period
    }

    function prepare_offers_data(hist_round){
        bids=[];
        asks=[];
        if (offers != []){
            for (var i = 0; i < offers.length; i++){
                if (offers[i][0]==hist_round && offers[i][5]=="bid"){
                    bids.push([offers[i][2],offers[i][6]]);
                }
                if (offers[i][0]==hist_round && offers[i][5]=="ask"){
                    asks.push([offers[i][2],offers[i][6]]);
                }
            }
        }
    }

    function prepare_transaction_data(hist_round){
        buys=[];
        sells=[];
        if (transactions != []){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round && transactions[i][9]=="buy"){
                    buys.push([transactions[i][2],transactions[i][7]]);
                }
                if (transactions[i][0]==hist_round && transactions[i][9]=="sell"){
                    sells.push([transactions[i][2],transactions[i][7]]);
                }
            }
        }
    }

    function set_yaxis_limits(hist_round){
        period_offers = [];
        period_transactions = [];
        if (offers != []){
            for (var i = 0; i < offers.length; i++){
                if (offers[i][0]==hist_round){
                    period_offers.push(offers[i][6])
                }
            }
        }
        if (transactions != []){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round){
                    period_transactions.push(transactions[i][7])
                }
            }
        }
        // The following block of code ensures that the lower(upper) limits for the vertical axis take into consideration the min(max) of offers, transactions, and the demand and supply schedules
        max_offers = Math.max.apply(Math,period_offers);
        min_offers = Math.min.apply(Math,period_offers);
        max_transactions = Math.max.apply(Math,period_transactions);
        min_transactions = Math.min.apply(Math,period_transactions);
        max_y = Math.max(buyers_data[hist_round-1][1][1], max_offers, max_transactions) + 5;
        min_y = Math.max(Math.min(sellers_data[hist_round-1][1][1], min_offers, min_transactions) - 5,0);
    }

    function set_eq(hist_round){
        for (var i = 0; i < buyers_data[hist_round-1].length; i++){
            if (buyers_data[hist_round-1][i][1]<sellers_data[hist_round-1][i][1]){break;} // The equilibrium step of induced values is such that at this step, buyers' induced value is less than the sellers' induced value
            eq_q = buyers_data[hist_round-1][i+1][0];
            eq_p_l = buyers_data[hist_round-1][i+1][1];
            eq_p_h = sellers_data[hist_round-1][i+1][1];
        }
    }

    function reset_hist_nav_buttons(){
        hist_text.innerHTML = "Period " + hist_round;
        // In the first period, the go to 'First' and 'Previous' period buttons are disabled
        $("#btn-first").attr('disabled', true);
        $("#btn-prev").attr('disabled', true);
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);
    }

    $("#btn-first").on('click', function(e){
        hist_round = 1;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        draw_graph(hist_round);
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        $("#btn-first").attr('disabled', true);
        $("#btn-prev").attr('disabled', true);
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);
    });

    $("#btn-prev").on('click', function(e){
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);
        hist_round = hist_round - 1;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        draw_graph(hist_round);
        if (hist_round == 1){
            $("#btn-first").attr('disabled', true);
            $("#btn-prev").attr('disabled', true);
        }
    });

    $("#btn-next").on('click', function(e){
        $("#btn-prev").attr('disabled', false);
        $("#btn-first").attr('disabled', false);
        hist_round = hist_round + 1;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        draw_graph(hist_round);
        if (hist_round == total_rounds){
            $("#btn-next").attr('disabled', true);
            $("#btn-last").attr('disabled', true);
        }
    });

    $("#btn-last").on('click', function(e){
        hist_round = total_rounds;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        draw_graph(hist_round);
        $("#btn-first").attr('disabled', false);
        $("#btn-prev").attr('disabled', false);
        $("#btn-next").attr('disabled', true);
        $("#btn-last").attr('disabled', true);
    });

    function upd_pred_eq_box(){
        pred_eq_box.innerHTML  = '<b>' + 'PREDICTED EQUILIBRIUM' + '</b>' + '<br>' +
        '<b>' + 'Price Range: ' + '</b>' + Number(eq_p_l).toFixed(2) + "-" + Number(eq_p_h).toFixed(2) + '<br/>' +
        '<b>' + 'Quantity: ' + '</b>' + eq_q;
    }

    function draw_graph(hist_round){
        description.innerHTML = "<p>" + "The predicted equilibrium quantity is " + eq_q + "." + "</p>" +
        "<p>" + "The predicted equilibrium price range is between ECU " + Number(eq_p_l).toFixed(2) + " and ECU " + Number(eq_p_h).toFixed(2) + "." + "</p>";

        // Define a custom symbol path
        Highcharts.SVGRenderer.prototype.symbols.cross = function (x, y, w, h) {
            return ['M', x, y, 'L', x + w, y + h, 'M', x + w, y, 'L', x, y + h, 'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.cross = Highcharts.SVGRenderer.prototype.symbols.cross;
        }

        Highcharts.SVGRenderer.prototype.symbols.plus = function (x, y, w, h) {
            return ['M', x, y + h / 2, 'L', x + w, y + h / 2, 'M', x + w / 2, y, 'L', x + w / 2, y + h, 'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.plus = Highcharts.SVGRenderer.prototype.symbols.plus;
        }

        Highcharts.SVGRenderer.prototype.symbols.up = function (x, y, w, h) {
            return ['M', x, y + h, 'L', x + w/2, y, 'M', x + w/2, y, 'L', x + w, y+h,'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.up = Highcharts.SVGRenderer.prototype.symbols.up;
        }

        Highcharts.SVGRenderer.prototype.symbols.down = function (x, y, w, h) {
            return ['M', x, y, 'L', x + w/2, y+h, 'M', x + w/2, y+h, 'L', x + w, y,'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.down = Highcharts.SVGRenderer.prototype.symbols.down;
        }

        $(function() {
            $('#Graph').highcharts({
                chart: {
                    animation: false,
                    zoomType: 'y',
                },
                title: {
                    text: undefined,
                },
                legend: {
                    enabled: true,
                },
                credits: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        pointStart:0,
                        enableMouseTracking: false,
                        stickyTracking: false,
                        states: {
                            inactive: {
                                opacity: 1,
                            },
                        },
                        marker: {
                            enabled: false,
                        },
                    }
                },
                xAxis: {
                    title: {
                        text: 'Quantity',
                    },
                    min:0,
                    tickInterval: 1,
                },
                yAxis: {
                    title: {
                        text: 'Price (in ECUs)',
                    },
                    min:min_y,
                    max: max_y,
                    tickInterval: 1,
                },
                series: [{
                    name: "Demand Curve",
                    data: buyers_data[hist_round-1],
                    color:'#172F3A',
                    step:true,
                    zIndex: 1,
                },
                {
                    name: "Supply Curve",
                    data: sellers_data[hist_round-1],
                    color:'#C81010',
                    step:true,
                    zIndex: 2,
                },
                {
                    name: 'Bid',
                    data: bids,
                    color: '#1C9506',
                    marker: {
                        enabled:true,
                        symbol: "up",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#1C9506',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 5,
                },
                {
                    name: 'Ask',
                    data: asks,
                    color: '#DC9314',
                    marker: {
                        enabled:true,
                        symbol: "down",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#DC9314',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 4,
                },
                {
                    name: 'Buy',
                    data: buys,
                    color: '#269AD1',
                    marker: {
                        enabled:true,
                        symbol: "plus",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#269AD1',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 6,
                },
                {
                    name: 'Sell',
                    data: sells,
                    color: '#9E31D8',
                    marker: {
                        enabled:true,
                        symbol: "cross",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#9E31D8',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 3,
                }],
            }, function(chart) {
                $("#slider-range").slider({
                    orientation: "vertical",
                    range: true,
                    min: min_y,
                    max: max_y,
                    values: [min_y, max_y],
                    slide: function(event, ui) {
                        $("#amount_l").val(ui.values[0]);
                        $("#amount_h").val(ui.values[1]);
                        chart.yAxis[0].setExtremes(ui.values[0] - 0, ui.values[1] - 0)
                    }
                });
                $("#amount_l").val($("#slider-range").slider("values", 0));
                $("#amount_h").val($("#slider-range").slider("values", 1))
            });
        });
    }

    function populate_period_sum_table(hist_round){
        let events = [];

        if (offers != []){
            for (var i = 0; i < offers.length; i++){
                if (offers[i][0]==hist_round){
                    events.push([offers[i][1], offers[i][3], offers[i][5], offers[i][6], offers[i][7], ""])
                }
            }
        }

        if (transactions != []){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round){
                    if (transactions[i][9]=='ask' || transactions[i][9]=='sell'){
                        events.push([transactions[i][1], transactions[i][5], transactions[i][9], transactions[i][7], transactions[i][8], transactions[i][3]])
                    } else {
                        events.push([transactions[i][1], transactions[i][3], transactions[i][9], transactions[i][7], transactions[i][8], transactions[i][5]])
                    }
                }
            }
        }

        const dateFromStr = str => new Date('1970/01/01 ' + str);
        events = events.sort((a, b) => dateFromStr(b[0]) - dateFromStr(a[0]));

        console.log(events);


        $("#period_sum_table tr").remove(); // in case redrawing table
        let txt_header = "";
        txt_header += "<tr>";
        txt_header += "<th style='text-align:center;'>Time Left</th>"
        txt_header += "<th style='text-align:center;'>Subject ID</th>"
        txt_header += "<th style='text-align:center;'>Action</th>"
        txt_header += "<th style='text-align:center;'>Price</th>"
        txt_header += "<th style='text-align:center;'>Quantity</th>"
        txt_header += "<th style='text-align:center;'>Trade With</th>"
        txt_header += "</tr>"
        $('#period_sum_table thead').append(txt_header);

        let txt_row = "";
        for (var i = 0; i < events.length; i++){
            txt_row += "<tr>";
            if (i > 0 && events[i][0]==events[i-1][0] && events[i][1]==events[i-1][1] && events[i][2]==events[i-1][2]) {
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "" + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(events[i][3]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][4] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][5] + "</td>";
            } else {
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][0] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][1] + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][2] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(events[i][3]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][4] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][5] + "</td>";
            }
            txt_row += "</tr>";
        }
        $('#period_sum_table tbody').append(txt_row);
    }

    function populate_sub_info_table(hist_round){
        $("#sub_info_table tr").remove(); // in case redrawing table
        let txt_header = "";
        txt_header += "<tr>";
        txt_header += "<th style='text-align:center;'>Subject ID</th>"
        txt_header += "<th style='text-align:center;'>Role</th>"
        txt_header += "<th style='text-align:center;'>Units Endowed</th>"
        txt_header += "<th style='text-align:center;'>Units Traded</th>"
        txt_header += "<th style='text-align:center;'>Period Payoff</th>"
        txt_header += "<th style='text-align:center;'>Cumulative Payoff</th>"
        txt_header += "</tr>"
        $('#sub_info_table thead').append(txt_header);

        let txt_row = "";
        for (var i = 0; i < players_data.length; i++){
            if (players_data[i][2]==hist_round){
                txt_row += "<tr>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + players_data[i][0] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + players_data[i][1] + "</td>";
                units_endowed = 0;
                units_traded = 0;
                for (var j = 0; j < players_data[i][3].length; j++){
                    units_endowed += Number(players_data[i][3][j][1])
                    units_traded += Number(players_data[i][3][j][2])
                }
                session_payoff = 0;
                /*for (var j = 0; j < players_data.length; i++){
                }*/
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + units_endowed + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + units_traded + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(players_data[i][4]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(players_data[i][5]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "</tr>";
            }
        }
        $('#sub_info tbody').append(txt_row);
    }
</script>