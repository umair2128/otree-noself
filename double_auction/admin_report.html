<!-- Linking jQuery -->
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- Linking Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

<!-- Linking Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/modules/boost.js"></script>
<script src="https://code.highcharts.com/modules/pattern-fill.js"></script>


<div class="container">
    <br>
    <div class="row" style="vertical-align:middle;">
        <div class="col-10" style="border: none; text-align:justify">
            <span id="time_text" style="font-size: 120%;"></span> <!-- Text indicating experiment progress -->
        </div>
        <div class="col-2" style="border: none; text-align:right">
            <button class="btn-sm btn-primary" type="button" id="btn-refresh" onClick="window.location.reload()"><i></i>Refresh</button> <!-- Refresh button -->
        </div>
    </div>
    <br>
    <ul class="nav nav-tabs" id="myTab" role="tablist"> <!-- Tabs Panel -->
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="sub_info-tab" data-toggle="tab" href="#sub_info" role="tab" aria-controls="sub_info" aria-selected="true" onclick="show_sub_info()">Subject Info</a> <!-- Subject Info Tab button -->
        </li>

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Experiment Summary</a> <!-- Experiment Summary drop-down menu button -->
            <div class="dropdown-menu">
              <a class="dropdown-item" id="exp_sum-tab" data-toggle="tab" href="#exp_summary" aria-controls="exp_summary" aria-selected="false" onclick="show_exp_sum()">Experiment Summary Table</a> <!-- Experiment Summary Table button -->
              <a class="dropdown-item" id="exp_gra-tab" data-toggle="tab" href="#exp_graph" aria-controls="exp_graph" aria-selected="false" onclick="show_exp_gra()">Experiment Summary Graph</a> <!-- Experiment Summary Graph button -->
            </div>
        </li>

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Period Summary</a> <!-- Period Summary drop-down menu button -->
            <div class="dropdown-menu">
              <a class="dropdown-item" id="per_sum-tab" data-toggle="tab" href="#period_summary" aria-controls="period_summary" aria-selected="false" onclick="show_per_sum()">Period Summary Table</a> <!-- Period Summary Table button -->
              <a class="dropdown-item" id="per_gra-tab" data-toggle="tab" href="#period_graph" aria-controls="period_graph" aria-selected="false" onclick="show_per_gra()">Period Summary Graph</a> <!-- Period Summary Graph button -->
            </div>
        </li>

        <li class="nav-item" role="presentation">
            <a class="nav-link" id="sur_sum-tab" data-toggle="tab" href="#sur_sum" role="tab" aria-controls="sur_sum" aria-selected="false" onclick="show_sur_sum()">Surplus Summary</a> <!-- Surplus Summary button -->
        </li>
    </ul>
    <br>
    <div class="row" id="nav_panel" style="vertical-align:middle;align-items:center;justify-content: center;"> <!-- Navigation Buttons Panel -->
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-first"><i class="bi-chevron-double-left"></i></button>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-prev"><i class="bi-chevron-left"></i></button>
        </div>
        <div class="col-5" style="border: none;text-align:center;">
            <span id="hist_text"></span>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-next"><i class="bi-chevron-right"></i></button>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-last"><i class="bi-chevron-double-right"></i></button>
        </div>
    </div>

    <div class="tab-content" id="myTabContent">
        <div id="sub_info" class="tab-pane fade show active" role="tabpanel" aria-labelledby="sub_info-tab"> <!-- Content under the Subject Info Tab -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Subjects Table</h4>
            </div>
            <div class="row" style="height:500px;overflow-y:scroll;">
                <table id="sub_info_table" class="table table-sm" style="table-layout:fixed;height:6px;width:100%;border-collapse:collapse;"><thead></thead><tbody></tbody></table>
            </div>
        </div>

        <div id='exp_summary' class="tab-pane fade" role="tabpanel" aria-labelledby="exp_sum-tab"> <!-- Content under the Experiment Summary Table Tab -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Experiment Summary Table</h4>
            </div>
            <div class="row" style="height:500px;overflow-y:scroll;">
                <table id="exp_sum_table" class="table table-sm" style="table-layout:fixed;height:6px;width:100%;border-collapse:collapse;"><thead></thead><tbody></tbody></table>
            </div>
        </div>
        <div id='exp_graph' class="tab-pane fade"  role="tabpanel" aria-labelledby="exp_gra-tab"> <!-- Content under the Experiment Summary Graph Tab -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Experiment Summary Graph</h4>
            </div>
            <div class="row">
                <div class="col-12">
                    <table id="Container_es" width="100%">
                        <tr>
                            <td width="5%" valign="top" align="center"> <!-- Zoom slider for the graph sits here -->
                                <div class="mb-2"><input type="text" id="amount_h_es" readonly style="font-size:14px; width:100px; border:0; text-align:center; vertical-align:top; font-weight:bold;"></div>
                                <div id="slider-range_es" style="width:12px; height:280px;"></div>
                                <div class="mt-2"><input type="text" id="amount_l_es" readonly style="font-size:14px; width:100px; border:0; text-align:center; vertical-align:bottom; font-weight:bold;"></div>
                            </td>
                            <td width="95%">
                                <div id="Graph_es" style="height: 400px; min-width: 300px"></div> <!-- Experiment Summary Graph sits here -->
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div id='period_summary' class="tab-pane fade"  role="tabpanel" aria-labelledby="per_sum-tab"> <!-- Content under the Period Summary Table Tab -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Period Summary Table</h4>
            </div>
            <div class="row" style="height:500px;overflow-y:scroll;">
                <table id="period_sum_table" class="table table-sm" style="table-layout:fixed;height:6px;width:100%;border-collapse:collapse;"><thead></thead><tbody></tbody></table>
            </div>
        </div>
        <div id='period_graph' class="tab-pane fade"  role="tabpanel" aria-labelledby="per_gra-tab"> <!-- Content under the Period Summary Graph Tab -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Period Summary Graph</h4>
            </div>
            <div class="row">
                <div id="pred_eq_box" style="margin-left:15%;font-size:11px;width:20%;border:1px solid #c7ccb6;background-color:#ebf0da;vertical-align:bottom;text-align:left;justify-content:right;align-items:right;"></div>
            </div>
            <div class="row">
                <div class="col-12">
                    <table id="Container" width="100%">
                        <tr>
                            <td width="5%" valign="top" align="center"> <!-- Zoom slider for the graph sits here -->
                                <div class="mb-2"><input type="text" id="amount_h" readonly style="font-size:14px; width:100px; border:0; text-align:center; vertical-align:top; font-weight:bold;"></div>
                                <div id="slider-range" style="width:12px; height:280px;"></div>
                                <div class="mt-2"><input type="text" id="amount_l" readonly style="font-size:14px; width:100px; border:0; text-align:center; vertical-align:bottom; font-weight:bold;"></div>
                            </td>
                            <td width="95%">
                                <div id="Graph" style="height: 400px; min-width: 300px"></div> <!-- Period Summary Graph sits here -->
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div id="sur_sum" class="tab-pane fade" role="tabpanel" aria-labelledby="sur_sum-tab"> <!-- Content under the Surplus Summary Tab  -->
            <div class="row">
                <h4 style="text-align:center;vertical-align:middle">Surplus Summary</h4>
            </div>
            <div class="row" style="height:500px;overflow-y:scroll;">
                <table id="sur_sum_table" class="table table-sm" style="table-layout:fixed;height:6px;width:100%;border-collapse:collapse;"><thead></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
</div>


<style>
    form {
        display: none;
    }

    exp {
      display: inline-block;
      position: relative;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
      text-align: center;
    }

    exp:hover {
        z-index: 1;
        width: auto;
        font-family: monospace;
        background-color: #FFFFCC;
    }

    .btn-sm.btn-primary[disabled] {
        background-color: #8ac8ff;
        border-color: #66b8ff;
    }
</style>




<script>
    let offers = {{offers | safe}}; // A detailed list of all the bid/ask offers in the experiment
    let transactions = {{transactions | safe}}; // A detailed list of all the successful transactions in the experiment
    let total_rounds = {{total_rounds | safe}}; // Total number of periods/rounds in the experiment
    let num_types = {{ num_types | safe }}; // The number of types of buyers and sellers (either '1' or '2')
    let num_induc_val_steps = {{ num_induc_val_steps | safe }}; // The number of steps of induced values for each type of buyers/sellers
    let num_buyers = {{ num_buyers | safe }}; // Total number of buyers
    let num_sellers = {{ num_sellers | safe }}; // Total number of sellers
    let type1_buyers = {{ type1_buyers | safe }}; // The number of 'type 1' buyers
    let type1_sellers = {{ type1_sellers | safe }}; // The number of 'type 1' sellers
    let buyer_presets = {{ buyer_presets | safe }}; // Detailed data on induced values and quantities endowed at each induced value for buyers when there is only one type of buyers
    let seller_presets = {{ seller_presets | safe }}; // Detailed data on induced values and quantities endowed at each induced value for sellers when there is only one type of sellers
    let buyer_type1_presets = {{ buyer_type1_presets | safe }}; // Detailed data on induced values and quantities endowed at each induced value for 'type 1' buyers when there are two types of buyers
    let buyer_type2_presets = {{ buyer_type2_presets | safe }}; // Detailed data on induced values and quantities endowed at each induced value for 'type 2' buyers when there are two types of buyers
    let seller_type1_presets = {{ seller_type1_presets | safe }}; // Detailed data on induced values and quantities endowed at each induced value for 'type 1' sellers when there are two types of sellers
    let seller_type2_presets = {{ seller_type2_presets | safe }}; // Detailed data on induced values and quantities endowed at each induced value for 'type 2' sellers when there are two types of sellers
    let total_surplus = {{ total_surplus | safe }}; // The predicted total surplus (same in each period of the experiment)
    let players_data = {{players_data | safe}}; // Detailed data on players' role, inducements, trades, and payoff in the experiment
    let data_avail_for_rounds = {{ data_avail_for_rounds | safe }}; // Indicator for the conclusion of the experiment. '0' when the experiment is in progress
    let exp_start_time = {{exp_start_time | safe}}; // Indicator for the experiment getting underway. '0' when the experiment is yet to start
    let timeout_seconds = {{ timeout_seconds | safe }}; // Total seconds for which trading takes place in each period
    let wait_timeout_seconds = {{ wait_timeout_seconds | safe }}; // Total seconds for which subjects wait at the end of each trading period before the next period begins
    let start_timestamp = new Date(exp_start_time * 1000); // Converts the 'exp_start_time' variable to human readable format

    console.log('offers: ', offers);
    console.log('transactions: ', transactions);
    console.log('players_data: ', players_data);
    console.log ('data_avail_for_rounds: ', data_avail_for_rounds);
    console.log('exp_start_time: ', exp_start_time);
    console.log('timeout_seconds: ', timeout_seconds);
    console.log('wait_timeout_seconds: ', wait_timeout_seconds);
    console.log('start_timestamp: ', start_timestamp);
    console.log('buyer_presets: ', buyer_presets);
    console.log('seller_presets: ', seller_presets);
    console.log('buyer_type1_presets: ', buyer_type1_presets);
    console.log('buyer_type2_presets: ', buyer_type2_presets);
    console.log('seller_type1_presets: ', seller_type1_presets);
    console.log('seller_type2_presets: ', seller_type2_presets);

    let hist_text = document.getElementById('hist_text'); // Caption for the Navigation Tab indicating the period for which the information is displayed
    let time_text = document.getElementById('time_text'); // The span where the text indicating the progress of the experiment sits
    let refresh_btn = document.getElementById('btn-refresh'); // The 'Refresh' button

    let hist_round = 1; // Keeps track of the period/round for which the information is displayed (defaults to period 1 on page load/refresh)

    let max_y = 100; // The maximum value for the vertical axis (initially 100)
    let min_y = 0; // The minimum value for the vertical axis (initially 0)

    let eq_q_l = 0; // Captures the lower bound for predicted equilibrium quantity in a given period based on induced values
    let eq_q_h = 0; // Captures the upper bound for predicted equilibrium quantity in a given period based on induced values
    // Note on the two variables above: If custom inducements are used, then it is possible that the demand and supply curves have a horizontal intersection instead of a vertical one. These two variables cater to this possibility

    let eq_p_l = 0; // Captures the lower bound for the predicted equilibrium price in a given period based on induced values
    let eq_p_h = 0; // Captures the upper bound for the predicted equilibrium price in a given period based on induced values

    let bids = []; // Uses 'offers' to populate the data on bids for the summary graph for a given period
    let asks = []; // Uses 'offers' to populate the data on asks for the summary graph for a given period
    let buys = []; // Uses 'transactions' to populate the data on purchases for the summary graph for a given period
    let sells = []; // Uses 'transactions' to populate the data on sales for the summary graph for a given period


    window.onload = function () {
        refresh_btn.style.visibility="hidden"; // The 'Refresh' button, by default, is hidden when the page loads
        prepare_demand_supply_data(); // Prepares the data used to plot the demand and supply curves on the graph drawn under the 'Period Summary Graph' tab
        prepare_exp_and_surplus_data(); // Prepares the data used to populate the 'Experiment Summary Table' and the 'Surplus Summary Table'
        setInterval(update_time_text, 1000); // Updates the text indicating the progress on the experiment after roughly every second
        reset_hist_nav_buttons(); // On page load or refresh, this resets the navigation buttons panel to their period 1 state
        set_yaxis_limits(hist_round); // Sets the vertical axis lower and upper limits for the summary graph for the given period
        set_eq(hist_round); // This determines the equilibrium price range and the equilibrium quantity given the induced values in the period in question
        prepare_offers_data(hist_round); // Prepares the data to display 'bids' and 'asks' as scatter points on the summary graph for the given period
        prepare_transaction_data(hist_round); // Prepares the data to display 'buys' and 'sells' as scatter points on the summary graph for the given period
        populate_exp_sum_table(); // Populates the experiment summary table containing information on the number of contracts, number of units traded, average price, number of bids, number of asks, equilibrium price range, and efficiency in each period of the experiment
        populate_sub_info_table(hist_round); // Populates the subjects information table which displays, for each subject, their id, role, units endowed, units traded, period and cumulative payoffs in the given period
        populate_period_sum_table(hist_round); // Populates the period summary table which displays an ordered list (by time left) of offers (bids/asks) and transactions (purchases/sales) which have taken place in the given period
        populate_sur_sum_table(); // Populates the surplus summary table which displays the information on buyers surplus, sellers surplus, and dead-weight loss in each round in absolute as well as percentage terms
        upd_pred_eq_box(); // Shows the predicted equilibrium price range and quantity in the box on the top-left of the graph
        prepare_contract_curve(hist_round); // Prepares the data for the contract curve to be displayed on the 'Period Summary Graph'
        prepare_surplus_data(hist_round); // Prepares the data on buyers and sellers surplus so that these regions can be displayed on the 'Period Summary Graph'
        draw_graph(hist_round); // Draws the Period Summary Graph for the given period
        prep_exp_sum_gra_data(); // Prepares the data to be shown on the Experimental Summary Graph
        draw_graph_exp_sum(); // Draws the Experimental Summary Graph
    }


    function prepare_demand_supply_data(){
        buyers_data = [];
        sellers_data = [];

        if (num_types == 2) {
            for (var i = 0; i < total_rounds; i++) {
                for (var j = 0; j < num_induc_val_steps; j++) {
                    buyers_data.push([type1_buyers * parseInt(buyer_type1_presets[i][j][1]), buyer_type1_presets[i][j][0]], [(num_buyers - type1_buyers) * parseInt(buyer_type2_presets[i][j][1]), buyer_type2_presets[i][j][0]]);
                    sellers_data.push([type1_sellers * parseInt(seller_type1_presets[i][j][1]), seller_type1_presets[i][j][0]], [(num_sellers - type1_sellers) * parseInt(seller_type2_presets[i][j][1]), seller_type2_presets[i][j][0]]);
                }
            }
            buyers_data = gen_nested_list(buyers_data, 2 * num_induc_val_steps);
            sellers_data = gen_nested_list(sellers_data, 2 * num_induc_val_steps);
        } else {
            for (var i = 0; i < total_rounds; i++) {
                for (var j = 0; j < num_induc_val_steps; j++) {
                    buyers_data.push([num_buyers * parseInt(buyer_presets[i][j][1]), buyer_presets[i][j][0]]);
                    sellers_data.push([num_sellers * parseInt(seller_presets[i][j][1]), seller_presets[i][j][0]]);
                }
            }
            buyers_data = gen_nested_list(buyers_data, num_induc_val_steps);
            sellers_data = gen_nested_list(sellers_data, num_induc_val_steps);
        }

        for (var i = 0; i < buyers_data.length; i++){
            buyers_data[i].push([0,0]);
            buyers_data[i].push([0,Number.MAX_VALUE]);

            buyers_data[i].sort((a,b) => b[1] - a[1]);
        }

        for (var i = 0; i < sellers_data.length; i++){
            sellers_data[i].push([0,0]);
            sellers_data[i].push([0,Number.MAX_VALUE]);

            sellers_data[i].sort((a,b) => a[1] - b[1]);
        }

        let temp_buyers = JSON.parse(JSON.stringify(buyers_data)),
            temp_sellers = JSON.parse(JSON.stringify(sellers_data));

        for (var i = 0; i < buyers_data.length; i++){
            for (var j = 1; j < buyers_data[i].length; j++){
                buyers_data[i][j][0] = temp_buyers[i][j-1][0];
                buyers_data[i][j][0] += buyers_data[i][j-1][0];
            }
        }

        for (var i = 0; i < sellers_data.length; i++){
            for (var j = 1; j < sellers_data[i].length; j++){
                sellers_data[i][j][0] = temp_sellers[i][j-1][0];
                sellers_data[i][j][0] += sellers_data[i][j-1][0];
            }
        }
        console.log('buyers_data', buyers_data);
        console.log('sellers_data', sellers_data);
    }


    function prepare_exp_and_surplus_data(){
        num_bids = Array(parseInt(total_rounds)).fill(0);
        num_asks = Array(parseInt(total_rounds)).fill(0);
        contracts = Array(parseInt(total_rounds)).fill(0);
        volume = Array(parseInt(total_rounds)).fill(0);
        avg_price = Array(parseInt(total_rounds)).fill(0);
        total_actual_surplus = Array(parseInt(total_rounds)).fill(0);
        buyers_actual_surplus = Array(parseInt(total_rounds)).fill(0);
        sellers_actual_surplus = Array(parseInt(total_rounds)).fill(0);
        efficiency = Array(parseInt(total_rounds)).fill(0);

        if (data_avail_for_rounds != 0){

            if (offers.length != 0) {
                for (var i = 0; i < total_rounds; i++) {
                    for (var j = 0; j < offers.length; j++){
                        if (offers[j][0] == Number(i+1) && offers[j][5] == "bid"){
                            num_bids[i] += 1;
                        }
                        if (offers[j][0] == Number(i+1) && offers[j][5] == "ask"){
                            num_asks[i] += 1;
                        }
                    }
                }
            }

            if (transactions.length != 0) {
                for (var i = 0; i < total_rounds; i++) {
                    let numerator = 0,
                        denominator = 0;

                    for (var j = 0; j < transactions.length; j++){
                        if (transactions[j][0] == Number(i+1)){
                            numerator += parseFloat(transactions[j][7])*parseInt(transactions[j][8]);
                            denominator += parseInt(transactions[j][8]);

                            contracts[i] += 1;
                            volume[i] += parseInt(transactions[j][8]);
                        }
                    }

                    if(denominator != 0){
                        avg_price[i] = numerator/denominator;
                    }
                }
            }

            if (players_data.length != 0) {
                for (var i = 0; i < total_rounds; i++) {
                    for (var j = 0; j < players_data.length; j++){
                        if (players_data[j][2] == Number(i+1)){
                            total_actual_surplus[i] += parseFloat(players_data[j][4]);

                            if (players_data[j][1] == 'buyer'){
                                buyers_actual_surplus[i] += parseFloat(players_data[j][4]);
                            } else {
                                sellers_actual_surplus[i] += parseFloat(players_data[j][4]);
                            }
                        }
                    }
                    efficiency[i] = Number(100*parseFloat(total_actual_surplus[i])/parseFloat(total_surplus)).toFixed(2)
                }
            }

        }

        console.log('num_bids: ', num_bids);
        console.log('num_asks: ', num_asks);
        console.log('contracts: ', contracts);
        console.log('volume: ', volume);
        console.log('avg_price: ', avg_price);
        console.log('total_actual_surplus: ', total_actual_surplus);
        console.log('buyers_actual_surplus: ', buyers_actual_surplus);
        console.log('sellers_actual_surplus: ', sellers_actual_surplus);
        console.log('efficiency: ', efficiency);
    }


    function format_time(time){ // Formats the time to be shown indicating the experiment progress
        let totalSeconds = time;
        let hours = Math.floor(totalSeconds / 3600);
        totalSeconds %= 3600;
        let minutes = Math.floor(totalSeconds / 60);
        let seconds = totalSeconds % 60;

        let hrs = String(hours).padStart(2, "0");
        let mins = String(minutes).padStart(2, "0");
        let secs = String(seconds).padStart(2, "0");

        if (hours == 0){
            return mins + ":" + secs
        } else {
            return hrs + ":" + mins + ":" + secs
        }
    }

    function update_time_text(){ // Shows the text indicating the experiment progress
        if (exp_start_time == 0){ // When the experiment is yet to begin
            refresh_btn.style.visibility="visible";

            time_text.innerHTML = "Period 1 of trading is yet to begin. Data will be available once trading for all " +
                total_rounds + " periods has ended. Click on the " + '<b>' + "'Refresh'" + '</b>' + " button to check whether trading for the first " +
                "period has started.";
        }

        if (exp_start_time != 0) { // When the experiment has started
            start_values = [
               start_timestamp.getFullYear(),
               start_timestamp.getMonth()+1,
               start_timestamp.getDate(),
               start_timestamp.getHours(),
               start_timestamp.getMinutes(),
               start_timestamp.getSeconds(),
            ];
            start_time_in_sec = start_values[3]*3600 + start_values[4]*60 + start_values[5];
            exp_dur_in_sec = (total_rounds*timeout_seconds) + (total_rounds-1)*wait_timeout_seconds;
            exp_duration = format_time(exp_dur_in_sec);

            curr_timestamp = new Date();

            curr_values = [
                curr_timestamp.getFullYear(),
                curr_timestamp.getMonth() + 1,
                curr_timestamp.getDate(),
                curr_timestamp.getHours(),
                curr_timestamp.getMinutes(),
                curr_timestamp.getSeconds(),
            ];

            if (curr_values[0]==start_values[0] && curr_values[1]==start_values[1] && curr_values[2]==start_values[2]){ // Ensures that the current year, month, and day are the same as those for the start of the experiment
                curr_time_in_sec = curr_values[3]*3600 + curr_values[4]*60 + curr_values[5];

                time_since_start_in_sec = parseInt((curr_time_in_sec - start_time_in_sec)*0.9);
                time_since_start = format_time(time_since_start_in_sec);
            } else {
                time_since_start = "";
            }
        }

        if (exp_start_time != 0 && time_since_start != "" && time_since_start_in_sec < exp_dur_in_sec && data_avail_for_rounds == 0){ // Displays the text during the period when the experiment has started but when the expected completion time hasn't arrived
            time_text.innerHTML = "The experiment is now underway. Total duration for this experiment is " + '<b>' + exp_duration + '</b>' +
                ". It has been " + '<b>' + time_since_start + '</b>' + " since the experiment started. Data will be available once trading for all " +
                total_rounds + " periods has ended."

            refresh_btn.style.visibility="hidden";
        } else if (exp_start_time != 0 && (time_since_start == "" || time_since_start_in_sec > exp_dur_in_sec) && data_avail_for_rounds == 0){ // Displays the text during the period when the experiment has started and when the expected completion time has also arrived but when the experiment is still actually in progress
            time_text.innerHTML = "The experiment is currently underway. Click on the " + '<b>' + "'Refresh'" + '</b>' +
                " button to check whether the results of this experiment are ready."

            refresh_btn.style.visibility="visible";
        }

        if (exp_start_time != 0 && data_avail_for_rounds != 0){ // Displays the text after the experiment has finished and the data becomes available
            time_text.innerHTML = "The experiment has ended and the results of this experiment have now been displayed below."

            refresh_btn.style.visibility="hidden";
        }
    }


    function show_sub_info(){ // Shows the content under the 'Subject Info' tab and hides all other content
        $("#nav_panel").show();
        $("#sub_info").show();
        $("#period_summary").hide();
        $("#period_graph").hide();
        $("#exp_summary").hide();
        $("#exp_graph").hide();
        $("#sur_sum").hide();
    }


    function show_per_sum(){ // Shows the content under the 'Period Summary Table' tab and hides all other content
        $("#period_summary").show();
        $("#nav_panel").show();
        $("#sub_info").hide();
        $("#period_graph").hide();
        $("#exp_summary").hide();
        $("#exp_graph").hide();
        $("#sur_sum").hide();
    }


    function show_per_gra(){ // Shows the content under the 'Period Summary Graph' tab and hides all other content
        $("#period_graph").show();
        $("#nav_panel").show();
        $("#sub_info").hide();
        $("#period_summary").hide();
        $("#exp_summary").hide();
        $("#exp_graph").hide();
        $("#sur_sum").hide();
    }


    function show_exp_sum(){ // Shows the content under the 'Experiment Summary Table' tab and hides all other content
        $("#nav_panel").hide();
        $("#exp_summary").show();
        $("#sub_info").hide();
        $("#period_summary").hide();
        $("#period_graph").hide();
        $("#exp_graph").hide();
        $("#sur_sum").hide();
    }


    function show_exp_gra(){ // Shows the content under the 'Experiment Summary Graph' tab and hides all other content
        $("#nav_panel").hide();
        $("#exp_graph").show();
        $("#sub_info").hide();
        $("#period_summary").hide();
        $("#period_graph").hide();
        $("#exp_summary").hide();
        $("#sur_sum").hide();
    }

    function show_sur_sum(){ // Shows the content under the 'Surplus Summary' tab and hides all other content
        $("#nav_panel").hide();
        $("#sur_sum").show();
        $("#sub_info").hide();
        $("#period_summary").hide();
        $("#period_graph").hide();
        $("#exp_summary").hide();
        $("#exp_graph").hide();
    }


    function reset_hist_nav_buttons(){
        hist_text.innerHTML = "Period " + hist_round;

        if (total_rounds == 1){ // If the experiment only had a single period, then the navigation panel is disabled
            $("#btn-first").attr('disabled', true);
            $("#btn-prev").attr('disabled', true);
            $("#btn-next").attr('disabled', true);
            $("#btn-last").attr('disabled', true);
        } else {// In the first period (default), the go to 'Previous' and 'First' period buttons are disabled
            $("#btn-first").attr('disabled', true);
            $("#btn-prev").attr('disabled', true);
            $("#btn-next").attr('disabled', false);
            $("#btn-last").attr('disabled', false);
        }
    }


    function set_yaxis_limits(hist_round){ //Determines the vertical limits for the 'Period Summary Graph'
        period_offers = [];
        period_transactions = [];
        if (offers.length != 0){
            for (var i = 0; i < offers.length; i++){
                if (offers[i][0]==hist_round){
                    period_offers.push(offers[i][6])
                }
            }
        }
        if (transactions.length != 0){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round){
                    period_transactions.push(transactions[i][7])
                }
            }
        }
        // The following block of code ensures that the lower(upper) limits for the vertical axis take into consideration the min(max) of offers, transactions, and the demand and supply schedules
        max_offers = Math.max.apply(Math,period_offers);
        min_offers = Math.min.apply(Math,period_offers);
        max_transactions = Math.max.apply(Math,period_transactions);
        min_transactions = Math.min.apply(Math,period_transactions);
        max_y = Math.max(Math.max(buyers_data[hist_round-1][1][1],sellers_data[hist_round-1][((sellers_data[hist_round-1].length > 1) ? sellers_data[hist_round-1].length - 2 : 0)][1]), max_offers, max_transactions) + 1;
        min_y = Math.max(Math.min(Math.min(sellers_data[hist_round-1][1][1],buyers_data[hist_round-1][((buyers_data[hist_round-1].length > 1) ? buyers_data[hist_round-1].length - 2 : 0)][1]), min_offers, min_transactions) - 1,0);

        console.log('min_y: ', min_y, ', max_y: ', max_y);
    }


    function set_eq(hist_round){ // Determines the equilibrium price and quantity values/range to be displayed
        for (var i = 0; i < buyers_data[hist_round-1].length; i++){
            if (buyers_data[hist_round-1][i][1] < sellers_data[hist_round-1][i][1]) {break;}
            eq_p_l = ((i < buyers_data[hist_round-1].length-1) ? Math.max(buyers_data[hist_round - 1][i + 1][1], sellers_data[hist_round - 1][i][1]) : sellers_data[hist_round - 1][i][1]);
            eq_p_h = ((i < buyers_data[hist_round-1].length-1) ? Math.min(sellers_data[hist_round - 1][i + 1][1], buyers_data[hist_round - 1][i][1]) : buyers_data[hist_round - 1][i][1]);
            eq_q_l = (eq_p_l != eq_p_h) ? ((i < buyers_data[hist_round-1].length-1) ? buyers_data[hist_round - 1][i+1][0] : buyers_data[hist_round - 1][i][0]) : ((i < buyers_data[hist_round-1].length-1) ? buyers_data[hist_round - 1][i][0] : buyers_data[hist_round - 1][i-1][0])
            eq_q_h = (eq_p_l != eq_p_h) ? ((i < buyers_data[hist_round-1].length-1) ? buyers_data[hist_round - 1][i+1][0] : buyers_data[hist_round - 1][i][0]) : ((i < buyers_data[hist_round-1].length-1) ? buyers_data[hist_round - 1][i+1][0] : buyers_data[hist_round - 1][i][0])
        }

        console.log('eq_p_l: ', eq_p_l, 'eq_p_h: ', eq_p_h, ', eq_q_l: ', eq_q_l, ', eq_q_h: ', eq_q_h);
    }


    function prepare_offers_data(hist_round){ //Prepares the data on 'Bids' and 'Asks' to be shown on the 'Period Summary Graph'
        bids=[];
        asks=[];

        if (offers.length != 0){
            for (var i = 0; i < offers.length; i++){
                if (offers[i][0]==hist_round && offers[i][5]=="bid"){
                    bids.push([offers[i][2],offers[i][6]]);
                }
                if (offers[i][0]==hist_round && offers[i][5]=="ask"){
                    asks.push([offers[i][2],offers[i][6]]);
                }
            }
        }
        console.log('bids: ', bids);
        console.log('asks: ', asks);
    }


    function prepare_transaction_data(hist_round){ //Prepares the data on 'Buys' and 'Sells' to be shown on the 'Period Summary Graph'
        buys=[];
        sells=[];

        if (transactions.length != 0){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round && transactions[i][9]=="buy"){
                    buys.push([transactions[i][2],transactions[i][7]]);
                }
                if (transactions[i][0]==hist_round && transactions[i][9]=="sell"){
                    sells.push([transactions[i][2],transactions[i][7]]);
                }
            }
        }
        console.log('buys: ', buys);
        console.log('sells: ', sells);
    }


    function populate_exp_sum_table(){ // Prepares the 'Experiment Summary Table'
        $("#exp_sum_table tr").remove();
        let txt_header = "";
        txt_header += "<tr>";
        txt_header += "<th style='text-align:center;'>Period</th>"
        txt_header += "<th style='text-align:center;'>Contracts</th>"
        txt_header += "<th style='text-align:center;'>Volume</th>"
        txt_header += "<th style='text-align:center;'>Mean Price</th>"
        txt_header += "<th style='text-align:center;'>Bids</th>"
        txt_header += "<th style='text-align:center;'>Asks</th>"
        txt_header += "<th style='text-align:center;'>Eq. Price</th>"
        txt_header += "<th style='text-align:center;'>Efficiency</th>"
        txt_header += "</tr>"
        $('#exp_sum_table thead').append(txt_header);

        if (data_avail_for_rounds != 0){
            for (var i = 0; i < total_rounds; i++){
                let txt_row = "";

                txt_row += "<tr>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + eval(i+1) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + contracts[i] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + volume[i] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + Number(avg_price[i]).toFixed(2) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + num_bids[i] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + num_asks[i] + "</td>";

                price_l = 0
                price_h = 0

                for (var j = 0; j < buyers_data[i].length; j++){
                    if (buyers_data[i][j][1]<sellers_data[i][j][1]){break;} // Shows the equilibrium price range
                    price_l = ((j < buyers_data[i].length - 1) ? Math.max(buyers_data[i][j + 1][1], sellers_data[i][j][1]) : buyers_data[i][j][1]);
                    price_h = ((j < buyers_data[i].length - 1) ? Math.min(sellers_data[i][j + 1][1], buyers_data[i][j][1]) : sellers_data[i][j][1]);
                }

                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + (price_l == price_h ? Number(price_l).toFixed(2) : Number(price_l).toFixed(2) + " - " + Number(price_h).toFixed(2)) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + Number(efficiency[i]).toFixed(2) + "%" + "</td>";
                txt_row += "</tr>";

                $('#exp_sum_table tbody').append(txt_row);
            }
        }
    }


    function populate_sub_info_table(hist_round){ //Prepares the 'Subject Info' table
        $("#sub_info_table tr").remove();
        let txt_header = "";
        txt_header += "<tr>";
        txt_header += "<th style='text-align:center;'>Subject ID</th>"
        txt_header += "<th style='text-align:center;'>Role</th>"
        txt_header += "<th style='text-align:center;'>Units Endowed</th>"
        txt_header += "<th style='text-align:center;'>Units Traded</th>"
        txt_header += "<th style='text-align:center;'>Period Payoff</th>"
        txt_header += "<th style='text-align:center;'>Cumulative Payoff</th>"
        txt_header += "</tr>"
        $('#sub_info_table thead').append(txt_header);

        let txt_row = "";
        for (var i = 0; i < players_data.length; i++){
            if (players_data[i][2]==hist_round){
                txt_row += "<tr>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + players_data[i][0] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + players_data[i][1] + "</td>";
                units_endowed = 0;
                units_traded = 0;
                for (var j = 0; j < players_data[i][3].length; j++){
                    units_endowed += Number(players_data[i][3][j][1]) // Adds up the values in the endowed units cells (index # 1) inside the nested players data list (index # 3) for each player for the given period
                    units_traded += Number(players_data[i][3][j][2]) // Adds up the values in the traded units cells (index # 2) inside the nested players data list (index # 3) for each player for the given period
                }
                session_payoff = 0;
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + units_endowed + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + units_traded + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(players_data[i][4]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(players_data[i][5]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "</tr>";
            }
        }
        $('#sub_info tbody').append(txt_row);
    }


    function populate_period_sum_table(hist_round){ // Prepares the 'Period Summary Table'
        let events = [];

        if (offers.length != 0){
            for (var i = 0; i < offers.length; i++){
                if (offers[i][0]==hist_round){
                    events.push([offers[i][1], offers[i][3], offers[i][5], offers[i][6], offers[i][7], ""])
                }
            }
        }

        if (transactions.length != 0){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round){
                    if (transactions[i][9]=='ask' || transactions[i][9]=='sell'){
                        events.push([transactions[i][1], transactions[i][5], transactions[i][9], transactions[i][7], transactions[i][8], transactions[i][3]])
                    } else {
                        events.push([transactions[i][1], transactions[i][3], transactions[i][9], transactions[i][7], transactions[i][8], transactions[i][5]])
                    }
                }
            }
        }

        // The following two lines are used to sort the 'events' list by 'Time Left' (highest to lowest)
        events.sort( function(a, b) {
          return (b[0].replace(/:/g, '') - a[0].replace(/:/g, ''));
        });

        console.log('events: ', events);

        $("#period_sum_table tr").remove(); // in case redrawing table
        let txt_header = "";
        txt_header += "<tr>";
        txt_header += "<th style='text-align:center;'>Time Left</th>"
        txt_header += "<th style='text-align:center;'>Subject ID</th>"
        txt_header += "<th style='text-align:center;'>Action</th>"
        txt_header += "<th style='text-align:center;'>Price</th>"
        txt_header += "<th style='text-align:center;'>Quantity</th>"
        txt_header += "<th style='text-align:center;'>Trade With</th>"
        txt_header += "</tr>"
        $('#period_sum_table thead').append(txt_header);

        let txt_row = "";
        for (var i = 0; i < events.length; i++){
            txt_row += "<tr>";
            if (i > 0 && events[i][0].substring(0, events[i][0].length-4)==events[i-1][0].substring(0, events[i-1][0].length-4) && events[i][1]==events[i-1][1] && events[i][2]==events[i-1][2]) { // If a transaction is carried out immediately after a bid(ask) is above(below) the lowest(highest) ask(bid) price in the queue, then there is no need to replicate the information in some cells from the row immediately above
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "" + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(events[i][3]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][4] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][5] + "</td>";
            } else {
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][0].substring(0, events[i][0].length-4) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][1] + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][2] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + "<exp>" + Number(events[i][3]).toFixed(2) + "</exp>" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][4] + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + events[i][5] + "</td>";
            }
            txt_row += "</tr>";
        }
        $('#period_sum_table tbody').append(txt_row);
    }


    function populate_sur_sum_table() { // Prepares the 'Surplus Summary' table
        $("#sur_sum_table tr").remove();
        let txt_header = "";
        txt_header += "<tr>";
        txt_header += "<th style='text-align:center;'>Period</th>"
        txt_header += "<th style='text-align:center;'>Buyer Surplus</th>"
        txt_header += "<th style='text-align:center;'>Buyer Surplus (%)</th>"
        txt_header += "<th style='text-align:center;'>Seller Surplus</th>"
        txt_header += "<th style='text-align:center;'>Seller Surplus (%)</th>"
        txt_header += "<th style='text-align:center;'>DW Loss</th>"
        txt_header += "<th style='text-align:center;'>DW Loss (%)</th>"
        txt_header += "</tr>"
        $('#sur_sum_table thead').append(txt_header);

        if (data_avail_for_rounds != 0) {
            for (var i = 0; i < total_rounds; i++) {
                let txt_row = "";

                txt_row += "<tr>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + eval(i + 1) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + buyers_actual_surplus[i].toFixed(2) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + eval(100 * buyers_actual_surplus[i] / total_surplus).toFixed(2) + "%" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + sellers_actual_surplus[i].toFixed(2) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + eval(100 * sellers_actual_surplus[i] / total_surplus).toFixed(2) + "%" + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + eval(total_surplus - total_actual_surplus[i]).toFixed(2) + "</td>";
                txt_row += "<td style='vertical-align:middle;text-align:center;'>" + eval(100 * (total_surplus - total_actual_surplus[i]) / total_surplus).toFixed(2) + "%" + "</td>";
                txt_row += "</tr>";

                $('#sur_sum_table tbody').append(txt_row);
            }

        }
    }


    function upd_pred_eq_box(){ // Updates the information displayed in the 'Predicted Equilibrium' box above the 'Period Summary Graph'
        pred_eq_box.innerHTML  = '<b>' + 'PREDICTED EQUILIBRIUM' + '</b>' + '<br>' +
        '<b>' + 'Price' + (eq_p_l < eq_p_h ? ' Range: ' + '</b>' + Number(eq_p_l).toFixed(2) + '-' + Number(eq_p_h).toFixed(2) : ': ' + '</b>' + Number(eq_p_h).toFixed(2))  + '<br/>' +
        '<b>' + 'Quantity' + (eq_q_l < eq_q_h ? ' Range: ' + '</b>' + eq_q_l + '-' + eq_q_h : ': ' + '</b>' + eq_q_h);
    }


    function prepare_contract_curve(hist_round){ // Prepares the data for the contract curve to be displayed on the 'Period Summary Graph'
        contract_curve_data = []

        if (transactions.length != 0){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round){
                    contract_curve_data.push([transactions[i][2]-1, transactions[i][7]])
                }
            }
            contract_curve_data.push([contract_curve_data[contract_curve_data.length-1][0]+1,contract_curve_data[contract_curve_data.length-1][1]])
        }
        console.log('contract_curve_data: ', contract_curve_data)
    }


    function prepare_surplus_data(hist_round){ // Prepares the data on buyers and sellers surplus so that these regions can be displayed on the 'Period Summary Graph'
        upd_contract_curve_data = [];
        upd_buyers_data =[];
        upd_sellers_data = [];
        buyer_surplus_data = [];
        seller_surplus_data = [];

        buyer_surplus_seller_loss = [];
        seller_surplus_buyer_loss = [];


        if (contract_curve_data.length != 0){
            for (var i = 0; i < contract_curve_data[contract_curve_data.length-1][0]+1; i++){
                for (var j = 0; j < contract_curve_data.length; j++){
                    if(j < contract_curve_data.length-1 && i >= contract_curve_data[j][0] && i < contract_curve_data[j+1][0]){
                        upd_contract_curve_data.push([i, contract_curve_data[j][1]]);
                        break;
                    } else if (j == contract_curve_data.length-1){
                        upd_contract_curve_data.push([i, contract_curve_data[j][1]]);
                        break;
                    }
                }
            }

            for (var i = 0; i < contract_curve_data[contract_curve_data.length-1][0]+1; i++){
                for (var j = 0; j < buyers_data[hist_round-1].length; j++){
                    if(i >= buyers_data[hist_round-1][j+1][0] && i < buyers_data[hist_round-1][j+2][0]){break;}
                }
                upd_buyers_data.push([i, buyers_data[hist_round-1][j+1][1]]);
            }

            for (var i = 0; i < contract_curve_data[contract_curve_data.length-1][0]+1; i++){
                for (var j = 0; j < sellers_data[hist_round-1].length; j++){
                    if(i >= sellers_data[hist_round-1][j+1][0] && i < sellers_data[hist_round-1][j+2][0]){break;}
                }
                upd_sellers_data.push(((j+1 < sellers_data[hist_round-1].length-1) ? [i, sellers_data[hist_round-1][j+1][1]] : [i, sellers_data[hist_round-1][j+1][1]]));
            }

            for (var i = 0; i < contract_curve_data[contract_curve_data.length-1][0]+1; i++){
                if (upd_buyers_data[i][1] >= upd_sellers_data[i][1]){
                    if(upd_buyers_data[i][1] >= upd_contract_curve_data[i][1]){
                        if (upd_contract_curve_data[i][1] >= upd_sellers_data[i][1]){
                            buyer_surplus_data.push([upd_contract_curve_data[i][1],upd_buyers_data[i][1]])
                            buyer_surplus_seller_loss.push([0,0])
                        } else if (upd_contract_curve_data[i][1] < upd_sellers_data[i][1]){
                            buyer_surplus_data.push([upd_sellers_data[i][1],upd_buyers_data[i][1]])
                            buyer_surplus_seller_loss.push([upd_contract_curve_data[i][1],upd_sellers_data[i][1]])
                        }
                    } else if (upd_buyers_data[i][1] < upd_contract_curve_data[i][1]){
                        buyer_surplus_data.push([0,0])
                        buyer_surplus_seller_loss.push([0,0])
                    }
                } else {
                    buyer_surplus_data.push([0,0])
                    if(upd_buyers_data[i][1] >= upd_contract_curve_data[i][1]){
                        buyer_surplus_seller_loss.push([upd_contract_curve_data[i][1],upd_buyers_data[i][1]])
                    } else {
                        buyer_surplus_seller_loss.push([0,0])
                    }
                }
            }

            for (var i = 0; i < contract_curve_data[contract_curve_data.length-1][0]+1; i++){
                if (upd_buyers_data[i][1] >= upd_sellers_data[i][1]) {
                    if (upd_sellers_data[i][1] <= upd_contract_curve_data[i][1]) {
                        if (upd_contract_curve_data[i][1] <= upd_buyers_data[i][1]){
                            seller_surplus_data.push([upd_sellers_data[i][1], upd_contract_curve_data[i][1]])
                            seller_surplus_buyer_loss.push([0,0])
                        } else if (upd_contract_curve_data[i][1] > upd_buyers_data[i][1]){
                            seller_surplus_data.push([upd_sellers_data[i][1], upd_buyers_data[i][1]])
                            seller_surplus_buyer_loss.push([upd_buyers_data[i][1],upd_contract_curve_data[i][1]])
                        }
                    } else if (upd_sellers_data[i][1] > upd_contract_curve_data[i][1]) {
                        seller_surplus_data.push([0, 0])
                        seller_surplus_buyer_loss.push([0,0])
                    }
                }else{
                    seller_surplus_data.push([0, 0])
                    if (upd_sellers_data[i][1] <= upd_contract_curve_data[i][1]) {
                        seller_surplus_buyer_loss.push([upd_sellers_data[i][1], upd_contract_curve_data[i][1]])
                    } else {
                        seller_surplus_buyer_loss.push([0,0])
                    }
                }
            }
        }
        console.log('upd_contract_curve_data: ', upd_contract_curve_data);
        console.log('upd_buyers_data: ', upd_buyers_data);
        console.log('upd_sellers_data: ', upd_sellers_data);
        console.log('buyer_surplus_data: ', buyer_surplus_data);
        console.log('seller_surplus_data: ', seller_surplus_data);
        console.log('buyer_surplus_seller_loss: ', buyer_surplus_seller_loss);
        console.log('seller_surplus_buyer_loss: ', seller_surplus_buyer_loss);
    }


    function draw_graph(hist_round){ // Draws the 'Period Summary Graph'
        // Defines a custom symbol path which looks like a right side up 'T' which will be used to represent sales
        Highcharts.SVGRenderer.prototype.symbols.rightside_up_t = function (x, y, w, h) {
            return ['M', x, y, 'L', x + w, y, 'M', x + w/2, y, 'L', x + w/2, y + h/2, 'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.rightside_up_t = Highcharts.SVGRenderer.prototype.symbols.rightside_up_t;
        }

        // Defines a custom symbol path which looks like an upside down 'T' which will be used to represent purchases
        Highcharts.SVGRenderer.prototype.symbols.upside_down_t = function (x, y, w, h) {
            return ['M', x, y + h, 'L', x + w, y + h, 'M', x + w/2, y + h, 'L', x + w/2, y + h/2, 'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.upside_down_t = Highcharts.SVGRenderer.prototype.symbols.upside_down_t;
        }

        // Defines a custom symbol path which looks like a right side up '^' which will be used to represent bids
        Highcharts.SVGRenderer.prototype.symbols.up = function (x, y, w, h) {
            return ['M', x, y + h, 'L', x + w/2, y + h/2, 'M', x + w/2, y + h/2, 'L', x + w, y + h,'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.up = Highcharts.SVGRenderer.prototype.symbols.up;
        }

        // Defines a custom symbol path which looks like an upside down '^' which will be used to represent asks
        Highcharts.SVGRenderer.prototype.symbols.down = function (x, y, w, h) {
            return ['M', x, y, 'L', x + w/2, y + h/2, 'M', x + w/2, y + h/2, 'L', x + w, y,'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.down = Highcharts.SVGRenderer.prototype.symbols.down;
        }

        // The following block of code basically tweaks the default 'plotBands' settings for highcharts to make the equilibrium price range band terminate at the equilibrium quantity (at the default settings, this band would have extended indefinitely along the horizontal axis)
        (function(H) {
          H.wrap(H.PlotLineOrBand.prototype, 'render', function(proceed, lines) {
            let ret = proceed.apply(this, Array.prototype.slice.call(arguments, 1));
            let {
              start,
              end
            } = ret.options,
              path = ret.svgElem.attr('d').split(' '),
              [x1Index, y1Index, x2Index, y2Index] = [1, 2, 4, 5],
              [x3Index, y3Index, x4Index, y4Index] = [7, 8, 10, 11],

              isPlotLineVertical = Math.abs(path[x1Index] - path[x2Index]) < 0.00001;
            if (isPlotLineVertical) {
              if (start) {
                path[y1Index] = ret.axis.chart.yAxis[0].toPixels(start);
                path[y4Index] = ret.axis.chart.yAxis[0].toPixels(start);

              }
              if (end) {
                path[y2Index] = ret.axis.chart.yAxis[0].toPixels(end);
                path[x3Index] = ret.axis.chart.yAxis[0].toPixels(end);

              }
            } else {
              if (start) {
                path[x1Index] = ret.axis.chart.xAxis[0].toPixels(start);
                path[x4Index] = ret.axis.chart.xAxis[0].toPixels(start);

              }
              if (end) {
                path[x2Index] = ret.axis.chart.xAxis[0].toPixels(end);
                path[x3Index] = ret.axis.chart.xAxis[0].toPixels(end);

              }
            }

            ret.svgElem.attr({
              d: path.join(' ')
            });

            return ret;
          });
        }(Highcharts));

        $(function() { // Draws the 'Period Summary Graph'
            $('#Graph').highcharts({
                chart: {
                    animation: false,
                    zoomType: 'y',
                },
                title: {
                    text: undefined,
                },
                legend: {
                    enabled: true,
                },
                credits: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        pointStart:0,
                        enableMouseTracking: false,
                        stickyTracking: false,
                        states: {
                            inactive: {
                                opacity: 1,
                            },
                        },
                        marker: {
                            enabled: false,
                        },
                    }
                },
                xAxis: {
                    title: {
                        text: 'Quantity',
                    },
                    min:0,
                    tickInterval: 1,
                },
                yAxis: {
                    title: {
                        text: 'Price (in ECUs)',
                    },
                    min:min_y,
                    max: max_y,
                    tickInterval: 1,
                    plotBands: [{
                      from: eq_p_l,
                      to: eq_p_h,
                      start: 0,
                      end: ((eq_q_l < eq_q_h) ? eq_q_l : eq_q_h),
                      color: '#ebf0da',
                    }],
                },
                series: [{
                    name: "Demand Curve",
                    data: buyers_data[hist_round-1],
                    color:'#28aeb8',
                    step:true,
                    zIndex: 3,
                },
                {
                    name: "Supply Curve",
                    data: sellers_data[hist_round-1],
                    color:'#691111',
                    step:true,
                    zIndex: 4,
                },
                {
                    name: "Contract Curve",
                    data: contract_curve_data,
                    color:'#b3b3b3',
                    step:true,
                    zIndex: 5,
                },
                {
                    name: "Buyer Surplus",
                    type: 'arearange',
                    data: buyer_surplus_data,
                    color:'#bce7eb',
                    step:true,
                    lineWidth:0,
                    zIndex: 1,
                },
                {
                    name: "Buyer Surplus, Seller Loss",
                    type: 'arearange',
                    data: buyer_surplus_seller_loss,
                    color: {
                        pattern: {
                               backgroundColor:'#bce7eb',
                               path: {
                                   d: 'M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11',
                                   fill: '#000000',
                                   strokeWidth: 3
                               },
                               width: 10,
                               height: 10,
                               color: '#ffffff',
                               opacity: 1
                        },
                    },
                    linkedTo: ':previous',
                    step:true,
                    lineWidth:0,
                    zIndex: 1,
                    showInLegend: false,
                },
                {
                    name: "Seller Surplus",
                    type: 'arearange',
                    data: seller_surplus_data,
                    color:'#edd5d5',
                    step:true,
                    lineWidth:0,
                    zIndex: 2,
                },
                {
                    name: "Seller Surplus, Buyer Loss",
                    type: 'arearange',
                    data: seller_surplus_buyer_loss,
                    color: {
                        pattern: {
                               backgroundColor:'#edd5d5',
                               path: {
                                   d: 'M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11',
                                   fill: '#000000',
                                   strokeWidth: 3
                               },
                               width: 10,
                               height: 10,
                               color: '#ffffff',
                               opacity: 1
                        },
                    },
                    linkedTo: ':previous',
                    step:true,
                    lineWidth:0,
                    zIndex: 1,
                    showInLegend: false,
                },
                {
                    name: 'Bid',
                    data: bids,
                    color: '#3c9c13',
                    marker: {
                        enabled:true,
                        symbol: "up",
                        radius: 5,
                        lineWidth: 2,
                        lineColor: '#3c9c13',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 8,
                },
                {
                    name: 'Ask',
                    data: asks,
                    color: '#cc8604',
                    marker: {
                        enabled:true,
                        symbol: "down",
                        radius: 5,
                        lineWidth: 2,
                        lineColor: '#cc8604',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 9,
                },
                {
                    name: 'Buy',
                    data: buys,
                    color: '#281ccf',
                    marker: {
                        enabled:true,
                        symbol: "upside_down_t",
                        radius: 5,
                        lineWidth: 2,
                        lineColor: '#281ccf',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 7,
                },
                {
                    name: 'Sell',
                    data: sells,
                    color: '#d61ec7',
                    marker: {
                        enabled:true,
                        symbol: "rightside_up_t",
                        radius: 5,
                        lineWidth: 2,
                        lineColor: '#d61ec7',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 6,
                }],
            }, function(chart) { // Sets the range for the zoom slider
                $("#slider-range").slider({
                    orientation: "vertical",
                    range: true,
                    min: Math.floor(min_y),
                    max: Math.ceil(max_y),
                    values: [Math.floor(min_y), Math.ceil(max_y)],
                    slide: function(event, ui) {
                        $("#amount_l").val(ui.values[0]);
                        $("#amount_h").val(ui.values[1]);
                        chart.yAxis[0].setExtremes(ui.values[0] - 0, ui.values[1] - 0)
                    }
                });
                $("#amount_l").val($("#slider-range").slider("values", 0));
                $("#amount_h").val($("#slider-range").slider("values", 1))
            });
        });
    }


    function prep_exp_sum_gra_data(){ // Prepares the data to be shown on the Experimental Summary Graph
        remaining_contracts = []
        closing_contracts = []

        if (transactions.length != 0){
            for (var i = 0; i < transactions.length; i++){
                if(i == transactions.length-1 || (i < transactions.length-1 && transactions[i][0] != transactions[i+1][0])){
                    closing_contracts.push([transactions[i][0], transactions[i][7]])
                } else {
                    remaining_contracts.push([transactions[i][0], transactions[i][7]])
                }
            }
        }
        console.log('remaining_contracts: ', remaining_contracts)
        console.log('closing_contracts: ', closing_contracts)

        eq_range = []

        for (var i = 0; i < buyers_data.length; i++){
            for (var j = 0; j < buyers_data[i].length; j++) {
                if (buyers_data[i][j][1] < sellers_data[i][j][1]) {break;}
            }
            j += -1
            eq_range.push(((j < buyers_data[i].length - 1) ? [Math.max(buyers_data[i][j + 1][1], sellers_data[i][j][1]),Math.min(sellers_data[i][j + 1][1], buyers_data[i][j][1])] : [buyers_data[i][j][1],sellers_data[i][j][1]]));
        }

        console.log('eq_range: ', eq_range);

        console.log(get_multi_array_min(remaining_contracts,1));
        console.log(get_multi_array_max(remaining_contracts,1));

        max_y_es = Math.max(get_multi_array_max(remaining_contracts,1), get_multi_array_max(closing_contracts,1), get_multi_array_max(eq_range,1)) + 1;
        min_y_es = Math.max(Math.min(get_multi_array_min(remaining_contracts,1), get_multi_array_min(closing_contracts,1), get_multi_array_min(eq_range,0)) - 1,0);
    }


    function draw_graph_exp_sum(){ // Draws the Experiment Summary Graph
        // Defines a custom symbol path which looks like a 90 degree rotated 'H' which will be used to represent the equilibrium price range
        Highcharts.SVGRenderer.prototype.symbols.error_bar = function (x, y, w, h) {
            return ['M', x, y, 'L', x + w, y, 'M', x + w/2, y, 'L', x + w/2, y + h, 'M', x, y + h, 'L', x + w, y + h, 'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.error_bar = Highcharts.SVGRenderer.prototype.symbols.error_bar;
        }

        $(function() {
            $('#Graph_es').highcharts({
                chart: {
                    animation: false,
                    zoomType: 'y',
                },
                title: {
                    text: undefined,
                },
                legend: {
                    enabled: true,
                },
                credits: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        pointStart:1,
                        enableMouseTracking: false,
                        stickyTracking: false,
                        states: {
                            inactive: {
                                opacity: 1,
                            },
                        },
                        marker: {
                            enabled: false,
                        },
                    }
                },
                xAxis: {
                    title: {
                        text: 'Period',
                    },
                    min:1,
                    tickInterval: 1,
                },
                yAxis: {
                    title: {
                        text: 'Price (in ECUs)',
                    },
                    min:min_y_es,
                    max: max_y_es,
                    tickInterval: 1,
                },
                series: [{
                    name: 'Contracts',
                    data: remaining_contracts,
                    color: '#1a4282',
                    marker: {
                        enabled:true,
                        symbol: "circle",
                        radius: 4,
                        lineWidth: 1,
                        lineColor: '#468bfa',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 1,
                },
                {
                    name: 'Closing Contracts',
                    data: closing_contracts,
                    color: '#c93262',
                    marker: {
                        enabled:true,
                        symbol: "circle",
                        radius: 4,
                        lineWidth: 1,
                        lineColor: '#ff8aaf',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                    zIndex: 2,
                },
                {
                    name: 'Comp. Eq. Price Range',
                    color: '#7e8082',
                    enableMouseTracking: false,
                    type: 'scatter',
                    showInLegend:true,
                    marker: {
                        enabled:true,
                        symbol: "error_bar",
                        radius: 5,
                        lineWidth: 2,
                        lineColor: '#7e8082',
                    },
                    zIndex: 3,
                },
                {
                    name: 'Eq. Range',
                    data: eq_range,
                    color: '#7e8082',
                    enableMouseTracking: false,
                    type: 'errorbar',
                    showInLegend:false,
                    zIndex: 4,
                }],
            }, function(chart) {
                $("#slider-range_es").slider({
                    orientation: "vertical",
                    range: true,
                    min: Math.floor(min_y_es),
                    max: Math.ceil(max_y_es),
                    values: [Math.floor(min_y_es), Math.ceil(max_y_es)],
                    slide: function(event, ui) {
                        $("#amount_l_es").val(ui.values[0]);
                        $("#amount_h_es").val(ui.values[1]);
                        chart.yAxis[0].setExtremes(ui.values[0] - 0, ui.values[1] - 0)
                    }
                });
                $("#amount_l_es").val($("#slider-range_es").slider("values", 0));
                $("#amount_h_es").val($("#slider-range_es").slider("values", 1))
            });
        });
    }


    function gen_nested_list(arr, len) { // Nests every 'len' number of items together into a sub-list within the parent list called 'arr'
      var chunks = [], i = 0, n = arr.length;
      while (i < n) {
        chunks.push(arr.slice(i, i += len));
      }
      return chunks;
    }


    function get_multi_array_min (arr, idx) { // Gets the minimum value at a particular index of a multi-dimensional array
        return Math.min.apply(null, arr.map(function (e) { return e[idx]}))
    }


    function get_multi_array_max (arr, idx) {// Gets the maximum value at a particular index of a multi-dimensional array
        return Math.max.apply(null, arr.map(function (e) { return e[idx]}))
    }


    $("#btn-first").on('click', function(e){ // Navigation Button: Go to the Beginning (i.e., first record)
        hist_round = 1;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        prepare_contract_curve(hist_round);
        prepare_surplus_data(hist_round);
        draw_graph(hist_round);
        populate_exp_sum_table();
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        $("#btn-first").attr('disabled', true);
        $("#btn-prev").attr('disabled', true);
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);
    });


    $("#btn-prev").on('click', function(e){ // Navigation Button: Go to the Previous record
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);
        hist_round = hist_round - 1;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        populate_exp_sum_table();
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        prepare_contract_curve(hist_round);
        prepare_surplus_data(hist_round);
        draw_graph(hist_round);
        if (hist_round == 1){
            $("#btn-first").attr('disabled', true);
            $("#btn-prev").attr('disabled', true);
        }
    });


    $("#btn-next").on('click', function(e){ // Navigation Button: Go to the Next record
        $("#btn-prev").attr('disabled', false);
        $("#btn-first").attr('disabled', false);
        hist_round = hist_round + 1;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        populate_exp_sum_table();
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        prepare_contract_curve(hist_round);
        prepare_surplus_data(hist_round);
        draw_graph(hist_round);
        if (hist_round == total_rounds){
            $("#btn-next").attr('disabled', true);
            $("#btn-last").attr('disabled', true);
        }
    });


    $("#btn-last").on('click', function(e){ // Navigation Button: Go to the End (i.e., last record)
        hist_round = total_rounds;
        hist_text.innerHTML = "Period " + hist_round;
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        populate_exp_sum_table();
        populate_sub_info_table(hist_round);
        populate_period_sum_table(hist_round);
        upd_pred_eq_box();
        prepare_contract_curve(hist_round);
        prepare_surplus_data(hist_round);
        draw_graph(hist_round);
        $("#btn-first").attr('disabled', false);
        $("#btn-prev").attr('disabled', false);
        $("#btn-next").attr('disabled', true);
        $("#btn-last").attr('disabled', true);
    });
</script>