<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
<!-- Bootstrap Font Icon CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

<!-- Linking Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/modules/boost.js"></script>

<div class="container">
    <div class="row" style="vertical-align:middle;align-items:left;">
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-first"><i class="bi-chevron-double-left"></i></button>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-prev"><i class="bi-chevron-left"></i></button>
        </div>
        <div class="col-7" style="border: none;text-align:center;">
            <span id="hist_text"></span>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-next"><i class="bi-chevron-right"></i></button>
        </div>
        <div class="col-1" style="border: none;">
            <button class="btn-sm btn-primary" type="button" id="btn-last"><i class="bi-chevron-double-right"></i></button>
        </div>
    </div>

    <div class="row">
        <div id="Graph" style="height: 400px"></div>
    </div>

    <div class="row">
        <span id="description"></span>
    </div>
</div>


<style>
    form {
        display: none;
    }

    .btn-sm.btn-primary[disabled] {
        background-color: #8ac8ff;
        border-color: #66b8ff;
    }
</style>

<script>
    let offers = {{offers | safe}};
    let transactions = {{transactions | safe}};
    let buyers_data = {{buyers_data | safe}};
    let sellers_data = {{sellers_data | safe}};
    let total_rounds = {{total_rounds | safe}};
    let hist_text = document.getElementById('hist_text');
    let description = document.getElementById('description');
    let hist_round = 1;
    let max_y = 100;
    let min_y = 0;
    let eq_q = 0;
    let eq_p_l = 0;
    let eq_p_h = 0;
    let bids = [];
    let asks = [];
    let buys = [];
    let sells = [];

    console.log("offers: ", offers);
    console.log("transactions: ", transactions);
    console.log("buyers data: ", buyers_data);
    console.log("sellers data: ", sellers_data);

    window.onload = function () {
        reset_hist_nav_buttons();
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        draw_graph(hist_round);
    }


    function prepare_offers_data(hist_round){
        bids=[];
        asks=[];
        if (offers != []){
            for (var i = 0; i < offers.length; i++){
                if (offers[i][0]==hist_round && offers[i][5]=="bid"){
                    bids.push([offers[i][2],offers[i][6]]);
                }
                if (offers[i][0]==hist_round && offers[i][5]=="ask"){
                    asks.push([offers[i][2],offers[i][6]]);
                }
            }
        }
    }


    function prepare_transaction_data(hist_round){
        buys=[];
        sells=[];
        if (transactions != []){
            for (var i = 0; i < transactions.length; i++){
                if (transactions[i][0]==hist_round && transactions[i][9]=="buy"){
                    buys.push([transactions[i][2],transactions[i][7]]);
                }
                if (transactions[i][0]==hist_round && transactions[i][9]=="sell"){
                    sells.push([transactions[i][2],transactions[i][7]]);
                }
            }
        }
    }


    function set_yaxis_limits(hist_round){
        max_y = buyers_data[hist_round-1][1][1] + 5;
        min_y = sellers_data[hist_round-1][1][1] - 5;
    }


    function set_eq(hist_round){
        for (var i = 0; i < buyers_data[hist_round-1].length; i++){
            if (buyers_data[hist_round-1][i][1]<sellers_data[hist_round-1][i][1]){break;}
            eq_q = buyers_data[hist_round-1][i+1][0];
            eq_p_l = buyers_data[hist_round-1][i+1][1];
            eq_p_h = sellers_data[hist_round-1][i+1][1];
        }
    }


    function reset_hist_nav_buttons(){
        hist_text.innerHTML = "Period " + hist_round + " Data";

        $("#btn-first").attr('disabled', true);
        $("#btn-prev").attr('disabled', true);
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);
    }


    $("#btn-first").on('click', function(e){
        hist_round = 1;
        hist_text.innerHTML = "Period " + hist_round + " Data";
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        draw_graph(hist_round);
        $("#btn-first").attr('disabled', true);
        $("#btn-prev").attr('disabled', true);
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);
    });


    $("#btn-prev").on('click', function(e){
        $("#btn-next").attr('disabled', false);
        $("#btn-last").attr('disabled', false);

        hist_round = hist_round - 1;
        hist_text.innerHTML = "Period " + hist_round + " Data";
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        draw_graph(hist_round);

        if (hist_round == 1){
            $("#btn-first").attr('disabled', true);
            $("#btn-prev").attr('disabled', true);
        }
    });


    $("#btn-next").on('click', function(e){
        $("#btn-prev").attr('disabled', false);
        $("#btn-first").attr('disabled', false);

        hist_round = hist_round + 1;
        hist_text.innerHTML = "Period " + hist_round + " Data";
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        draw_graph(hist_round);

        if (hist_round == total_rounds){
            $("#btn-next").attr('disabled', true);
            $("#btn-last").attr('disabled', true);
        }
    });


    $("#btn-last").on('click', function(e){
        hist_round = total_rounds;
        hist_text.innerHTML = "Period " + hist_round + " Data";
        set_yaxis_limits(hist_round);
        set_eq(hist_round);
        prepare_offers_data(hist_round);
        prepare_transaction_data(hist_round);
        draw_graph(hist_round);
        $("#btn-first").attr('disabled', false);
        $("#btn-prev").attr('disabled', false);
        $("#btn-next").attr('disabled', true);
        $("#btn-last").attr('disabled', true);
    });


    function draw_graph(hist_round){
        description.innerHTML = "<p>" + "The predicted equilibrium quantity is " + eq_q + "." + "</p>" +
        "<p>" + "The predicted equilibrium price range is between ECU " + Number(eq_p_l).toFixed(2) + " and ECU " + Number(eq_p_h).toFixed(2) + "." + "</p>";

        // Define a custom symbol path
        Highcharts.SVGRenderer.prototype.symbols.cross = function (x, y, w, h) {
            return ['M', x, y, 'L', x + w, y + h, 'M', x + w, y, 'L', x, y + h, 'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.cross = Highcharts.SVGRenderer.prototype.symbols.cross;
        }

        Highcharts.SVGRenderer.prototype.symbols.plus = function (x, y, w, h) {
            return ['M', x, y + h / 2, 'L', x + w, y + h / 2, 'M', x + w / 2, y, 'L', x + w / 2, y + h, 'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.plus = Highcharts.SVGRenderer.prototype.symbols.plus;
        }

        Highcharts.SVGRenderer.prototype.symbols.up = function (x, y, w, h) {
            return ['M', x, y + h, 'L', x + w/2, y, 'M', x + w/2, y, 'L', x + w, y+h,'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.up = Highcharts.SVGRenderer.prototype.symbols.up;
        }

        Highcharts.SVGRenderer.prototype.symbols.down = function (x, y, w, h) {
            return ['M', x, y, 'L', x + w/2, y+h, 'M', x + w/2, y+h, 'L', x + w, y,'z'];
        };
        if (Highcharts.VMLRenderer) {
            Highcharts.VMLRenderer.prototype.symbols.down = Highcharts.SVGRenderer.prototype.symbols.down;
        }

        $(function() {
            $('#Graph').highcharts({
                chart: {
                    animation: false,
                },
                title: {
                    text: "Predicted Market Demand and Supply Curves",
                },
                legend: {
                    enabled: true,
                },
                credits: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        pointStart:0,
                        enableMouseTracking: false,
                        stickyTracking: false,
                        states: {
                            inactive: {
                                opacity: 1,
                            },
                        },
                        marker: {
                            enabled: false,
                        },
                    }
                },
                xAxis: {
                    title: {
                        text: 'Quantity',
                    },
                    min:0,
                    tickInterval: 1,
                },
                yAxis: {
                    title: {
                        text: 'Price (in ECUs)',
                    },
                    min:min_y,
                    max: max_y,
                    tickInterval: 1,
                },
                series: [{
                    name: "Demand Curve",
                    data: buyers_data[hist_round-1],
                    color:'#172F3A',
                    step:true,
                },
                {
                    name: "Supply Curve",
                    data: sellers_data[hist_round-1],
                    color:'#C81010',
                    step:true,
                },
                {
                    name: 'Bid',
                    data: bids,
                    color: '#1C9506',
                    marker: {
                        enabled:true,
                        symbol: "up",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#1C9506',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                },
                {
                    name: 'Ask',
                    data: asks,
                    color: '#DC9314',
                    marker: {
                        enabled:true,
                        symbol: "down",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#DC9314',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                },
                {
                    name: 'Buy',
                    data: buys,
                    color: '#269AD1',
                    marker: {
                        enabled:true,
                        symbol: "plus",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#269AD1',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                },
                {
                    name: 'Sell',
                    data: sells,
                    color: '#9E31D8',
                    marker: {
                        enabled:true,
                        symbol: "cross",
                        radius: 4,
                        lineWidth: 2,
                        lineColor: '#9E31D8',
                    },
                    enableMouseTracking: false,
                    type: 'scatter',
                }],
            });
        });
    }
</script>